name: Distribution

on:
  push:
    branches:
      - develop

jobs:
  copr-build:
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    name: Build the RPM
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: echo "${{ secrets.COPR_CONF }}" > copr_conf
    - name: Build the package
      run: |
        docker run --name package-build -v $(pwd):/code:Z registry.fedoraproject.org/fedora:32 /bin/bash -c "
          dnf install -y git make rpmdevtools copr-cli rpm-build python3
          cd /code
          IFS='-' read version commits last_commit <<< \$(git describe)
          rpmdev-bumpspec \
            -n \"\$(cat VERSION.txt)-\$commits.\$last_commit%{?dist}\" \
            -c 'Rebuilt for latest' \
            -u 'autobuild <autobuild@localhost>' \
            -D \
            python-nitrate-tcms.spec
          make tarball srpm
          copr-cli --conf ./copr_conf build cqi/python-nitrate-tcms-testing dist/python-nitrate-tcms-*.src.rpm
        "

  build-image:
    name: Build the image
    needs: copr-build
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt-get install make
      - uses: actions/checkout@v2
      - run: make latest-image
      - name: Publish image
        run: |
          QUAY_USER=${{ secrets.quay_username }} QUAY_PASSWORD=${{ secrets.quay_token }} \
          CONTAINER=docker make publish-image
